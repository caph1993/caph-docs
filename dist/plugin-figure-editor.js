
caph.attach(...JSON.parse(LZUTF8.decompress("W3sicmVmIjoiY2FwaC1kb2NzL2xpYnJhcmllcy9zcGxpdMYGLmpzIiwiY29udGVudCI6Ii8vIFRoZSBwcm9ncmFtbWluZyBnb2FscyBvZiBTxzEgYXJlIHRvIGRlbGl2ZXIgcmVhZGFibGUsIHVuZGVyc3RhbsUQIGFuZFxuLy8gbWFpbnRhaW7FFWNvZGUsIHdoacQhdCB0aGUgc2FtZSB0aW1lIG1hbnVhbGx5IG9wdGltaXrkAIBmb3IgdGlueSBtaW5pZmllZCBmxDxzaXplLMVfYnJvd3NlciBjb21wYXRpYmlsaXR5IHdpdGhvdXQgYWRkaXRpb25hbCByZXF1aXJlbWVudHPFOmFuZCB2ZXJ5IGZldyBhc3N1bXDEK3MgYWLEO+QAnHVzZXIncyBwYWdlIGxheW91dC5cbmNvbnN0IGdsb2JhbCA9IHR5cGVvZiB3aW5kb3cgIT09ICfkAQpmaW5lZCcgP8gZOiBudWxsyD5zc3IgPclEPT3HHS8vxh9kb2N15ACpID0gIcQrP8crLskZOuUBb8VlXG7EOSBTYXZlIGEgY291cGxlIGxv5AE9dW5j5ADTIG5hbWVzIHRoYXTlAb91c+QBSOQBEWVudGx5LsVAVGhpc+gBemHFNnNhdmXkAfBvdW5kIDQwMCBieXRlc+kBAmFkZEV2ZW50TGlzdGVuZeQA0SfQFCfILXJlbW92ZdEw0xfJM2dldELEe2luZ0NsaWVudFJlY+QBEifVGco3dXR0ZXJTdGFydERyYWdn5AJGPSAnX2HJImFHxiNpemXFGmLJGmLPGmPJGkhPUklaT05UQUzEGWhvcml6b250YWzJIU5PT1AgPSAoKSA9PiBmYWxzZecBmEhlbHBlcuoBjGRldGVybWluZXPkAwhjaCBwcmVmaXhl5QNmQ1NTIGNhbGMgd2UgbmVlZOYBm1dlIG9ubHnFEuUDfG8gdOUBrm5jxBogc+QA7XVw5ANZZW7GG2Fub255bW91c8p5aXPEW2zHVcVZVGVzdHMgLXdlYmtpdCwgLW1veuUDFy1v6QCWLiBNb2TnA3pyb20gU3RhY2tPdmVyZmxvdzrFRmh0dHA6Ly9zxBpvxxouY29tL3F1ZXPEe3MvMTY2MjUxNDAvanMtZmVhdHVyZS3kAQnlAJotdG/HDS10aGUtdXNhZ2Utb2bnAJct5AEQ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", {inputEncoding: 'Base64'})));

caph.plugins.figureEditor = new class extends caph.Plugin {
  
  render(){
    const {option} = preact.useContext(caph.contexts.menu);
    const _class = option!='Figure Editor'?'hidden':'vbox fullscreen-layer';
    return html`
      <div id="fabric-editor-main" class=${_class}>
        <div id="fabric-editor-header" class="hbox space-between">
          <button onclick=${()=>caph.plugins.figureEditor.run()}>
            Run (ctrl+enter)
          </button>
          <div class="hbox align-center">
            <select onchange=${(e)=>
                caph.plugins.figureEditor.setTemplate(e.target.value)}>
              <option value="none">Load Template</option>
              <option value="figure">Figure</option>
              <option value="diagram">Diagram</option>
            </select>
          </div>
          <div/>
        </div>
        <div class="flex hbox" style="max-height: calc(100% - 2rem)">
          <div id="fabric-editor-body" class="vbox">
            <div id="fabric-editor-body-code" class="flex"/>
          </div>
          <div id="fabric-editor-footer" class="vbox">
            <div class="hbox align-center">
              <span>Scale figure:</span>
              <input type='range' value='100' min='10' max='100'
                  onchange=${(e)=>caph.plugins.figureEditor.rescale(e)}/>
            </div>
            <div id="fabric-editor-footer-canvas" class="flex vbox"/>
            <div id="fabric-editor-footer-code" class="flex"/>
          </div>
        </div>
      </div>
    `;
  }
  async loader(){
    await caph.loadPluginDeep('fabric');
    await caph.loadPluginDeep('codemirror');

    await caph.load('caph-docs/libraries/split/split.js');
    await caph.load('caph-docs/libraries/split/split.css');

    await caph.load('caph-docs/plugins/figure-editor/figure-editor.js');
    await caph.load('caph-docs/plugins/figure-editor/figure-editor.css');
    (async ()=>{
      let load = async (id)=>MyPromise.until(()=>
        document.querySelector(`#${id}`));
      let main = await load('fabric-editor-main');
      await this.init();
    })();
    return;
  }
  menuSettings(){
    const {addOption, setOption} = preact.useContext(caph.contexts.menu);
    addOption('Figure Editor', {hold:true});
  }
  

  loaded = {};
  async init(){
    let load = async (id)=>await MyPromise.until(()=>
      document.querySelector(`#${id}`));
    let [body, body_cm, footer, footer_canvas, footer_cm] = await Promise.all([
      'fabric-editor-body',
      'fabric-editor-body-code',
      'fabric-editor-footer',
      'fabric-editor-footer-canvas',
      'fabric-editor-footer-code'
    ].map(load));

    Split([body, footer], {direction: 'horizontal'});
    let cm_options={
      theme: 'monokai',
      indentUnit: 2,
      tabSize: 2,
      lineWrapping: true,
      lineNumbers: true,
      keyMap: 'sublime',
      scrollPastEnd: true,
    }
    this.cm = CodeMirror(body_cm, {
      value: this.getTemplate('none'),
      mode:  'javascript',
      extraKeys:{
        'Ctrl-Enter': (cm) => this.run(),
      },
      ...cm_options,
    });
    this.cm_footer = CodeMirror(footer_cm, {
      value: 'Select an element to see its properties...',
      mode:  'json',
      ...cm_options,
    });
    this.canvas_div=footer_canvas;
  }
  refresh(){
    this.cm.refresh();
    this.cm_footer.refresh();
    this.run();
  }
  rescale(e){
    let value = e.srcElement.value/100;
    this.canvas_div.style.transform = `scale(${value})`;
    this.canvas_div.style.transformOrigin = 'top left';
  }

  setTemplate(option){
    let code = this.getTemplate(option);
    this.cm.setValue(code);
    this.refresh();
  }
  getTemplate(option){
    let tmp=this.templates[option];
    let noindent = tmp.split('\n').map(
      s=>s.slice(4,s.length)
    ).join('\n').trim();
    return noindent+'\n';
  }

  async run(){
    this.canvas_div.innerHTML = '';
    let canvas = MyDocument.createElement('canvas', {
      parent: this.canvas_div,
    });
    let code = this.cm.getValue();
    code = code.replace(/\\/g, '\\\\');
    let fabric_canvas = new fabric.Canvas(canvas);
    fabric_canvas.on('object:modified', (ev)=>this.on_canvas_event(ev));
    //fabric_canvas.on('selection:created', (ev)=>this.on_canvas_event(ev));
    fabric_canvas.on('selection:updated', (ev)=>this.on_canvas_event(ev));
    this.cm_footer.setValue('');
    let diagramArgs = caph.plugins.fabricDiagram.exposed_args;
    try{ await eval(code)(fabric_canvas, diagramArgs); }
    catch(err){ this.cm_footer.setValue(''+err); }
    canvas.nextSibling.oncontextmenu=(ev)=>{
      ev.preventDefault();
      if(confirm('Download picture?')) this.download(canvas);
    };
  }
  on_canvas_event(ev){
    let obj = ev.target;
    let s = JSON.stringify(obj, null, '  ');
    this.cm_footer.setValue(s);
  }
  download(canvas){
    const link = document.createElement('a');
    link.download = 'image.png';
    link.href = this.serialize(canvas);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
  serialize(canvas){
    return canvas.toDataURL({
       width: canvas.width, height: canvas.height,
       left: 0, top: 0, format: 'png',
    });
  }

  templates = {
    none: `
    async (canvas, {})=>{
      // code goes here
    }`,
    diagram: `
    async (canvas, {draw, node, arrow, Row, Column})=>{
      let n = {
        X: node('X'),
        PY: node('\\hat Y'),
        Y: node('Y'),
        PYn: node('\\hat{\\tilde Y}'),
        Yn: node('\\tilde{Y}'),
      };
      let arrows = [
        arrow(n.X, n.PY, 'RL'),
        arrow(n.X, n.PYn, 'RL'),
        arrow(n.Y, n.PY, 'LR', {
          text: '\\mathcal L', dashed: true,
        }),
        arrow(n.Yn, n.PYn, 'LR', {
          text:'\\mathcal L', dashed: true,
        }),
      ];
      let layout = Row(
        n.X,
        Column(n.PY, n.PYn),
        Column(n.Y, n.Yn),
      );
      await draw(canvas, {
        nodes:n, arrows, layout,
        width:500, height:150,
        borders: false,
      });
    }`,
    figure: `
    (canvas)=>{
      let elems = [
        new fabric.Ellipse({
        left: 10, top: 10, fill: 'red', stroke: 'black',
        opacity: 0.5, rx: 150, ry: 80,
        }),
          new fabric.Ellipse({
          left: 70, top: 70, fill: 'green', stroke: 'black',
          opacity: 0.5, rx: 150, ry: 80,
        }),
        new fabric.Text('Truth', { left: 103, top: 24 }),
        new fabric.Text('Knowledge', { left: 90, top: 100 }),
        new fabric.Text('Belief', { left: 200, top: 180 }),
      ];
      elems.forEach(e=>canvas.add(e));
      canvas.setHeight(280);
      canvas.setWidth(400);
    }`,
  };
}